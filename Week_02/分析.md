# CG测试

本次测试在6核16G的java1.8windows环境下使用串行、并行、CMS、G1 四种回收器在不同堆空间（128M、256m、512m、1G、2G、4G）情况下压测同一段代码（GCLogAnalysis.java）的情况。执行次数如下表：

||128m|265m|384M|512m|640M|768M|896M|1G|2G|4G|
|:----|:----|:----|:----|:----|:----|:----|:----|:----|:----|:----|
|串行收集|OOM|4684|7653|9861|11732|12697|12758|12581|12631|12007|
|并行收集|OOM|OOM|5354|8241|10607|10836|12299|13000|14351|14304|
|CMS收集|OOM|4241|7531|10113|11856|13469|13278|13969|13827|13059|
|G1收集|OOM|OOM|6042|10484|12048|13618|13323|13338|11284|12864|

![图片](https://uploader.shimo.im/f/7OGALMwqyWo3O9bn.png!thumbnail)


可以看出在本例中执行次数随堆空间增加而线性增加，但到一定大小后(串行、CMS、G1 700M，并行 2G)增加堆大小对执行次数无改善。串行、CMS在256m的环境下还能正常运行，除了并行收集器以外其他收集器执行次数相差不大。

CG执行日志以串行回收堆大小512M环境为例，以下挑选了两条典型记录进行解读

```arduino
0.156: [GC (Allocation Failure) 0.156: [DefNew: 139776K->17472K(157248K), 0.0207605 secs] 139776K->44266K(506816K), 0.0208900 secs] [Times: user=0.00 sys=0.01, real=0.02 secs] 
0.198: [GC (Allocation Failure) 0.198: [DefNew: 157248K->17470K(157248K), 0.0270420 secs] 184042K->87967K(506816K), 0.0271095 secs] [Times: user=0.00 sys=0.02, real=0.03 secs] 
0.245: [GC (Allocation Failure) 0.245: [DefNew: 157221K->17471K(157248K), 0.0246421 secs] 227717K->137695K(506816K), 0.0247078 secs] [Times: user=0.00 sys=0.01, real=0.03 secs] 
0.290: [GC (Allocation Failure) 0.290: [DefNew: 157247K->17471K(157248K), 0.0233065 secs] 277471K->183107K(506816K), 0.0233709 secs] [Times: user=0.00 sys=0.02, real=0.02 secs] 
0.332: [GC (Allocation Failure) 0.332: [DefNew: 157247K->17471K(157248K), 0.0221789 secs] 322883K->225839K(506816K), 0.0222474 secs] [Times: user=0.02 sys=0.02, real=0.02 secs] 
...
0.816: [GC (Allocation Failure) 0.817: [DefNew: 139776K->139776K(157248K), 0.0000139 secs]0.817: [Tenured: 320259K->343426K(349568K), 0.0366014 secs] 460035K->343426K(506816K), [Metaspace: 2768K->2768K(1056768K)], 0.0366896 secs] [Times: user=0.05 sys=0.00, real=0.04 secs] 
0.872: [GC (Allocation Failure) 0.872: [DefNew: 139776K->139776K(157248K), 0.0000132 secs]0.872: [Tenured: 343426K->349544K(349568K), 0.0494290 secs] 483202K->349688K(506816K), [Metaspace: 2768K->2768K(1056768K)], 0.0495161 secs] [Times: user=0.05 sys=0.00, real=0.05 secs] 
0.943: [Full GC (Allocation Failure) 0.943: [Tenured: 349544K->349074K(349568K), 0.0515330 secs] 506549K->355303K(506816K), [Metaspace: 2768K->2768K(1056768K)], 0.0516009 secs] [Times: user=0.06 sys=0.00, real=0.05 secs] 
1.016: [Full GC (Allocation Failure) 1.016: [Tenured: 349352K->343012K(349568K), 0.0629740 secs] 506599K->343012K(506816K), [Metaspace: 2768K->2768K(1056768K)], 0.0630540 secs] [Times: user=0.06 sys=0.00, real=0.06 secs] 
```
在第0.156秒时发生一次yangCG【GC】，触发原因是创建对象分无法分配内存【 (Allocation Failure) 】，使用串行收集器【DefNew】。
yang区可用为157248K己使用139776K回收后还有17472K对象存活【139776K->17472K(157248K)】，CG时间0.02秒，【0.0207605 secs】。

总使用空间从139776K降到44266K【139776K->44266K(506816K)】即回收前老年区使用为：139776K-139776K=0k，回收后老年区使用：44266K-17472K=26794K

![图片](https://uploader.shimo.im/f/i1tO1lnDlSZK37zC.png!thumbnail)

# 压力测试

使用SuperBenchmarker压测gateway-server-0.0.1-SNAPSHOT.jar。

## 压力相同，堆空间对CG的影响

20并发运行30秒

|RPS|256M|512M|1G|2G|
|:----|:----|:----|:----|:----|
|串行收集|3651|3645|3840|3824|
|并行收集|4050|3891|4005|3245|
|CMS收集|3904|4036|3836|3422|
|G1收集|3880|3859|3919|3240|

|95%(ms)|256M|512M|1G|2G|
|:----|:----|:----|:----|:----|
|串行收集|2|2|2|2|
|并行收集|2|2|1|2|
|CMS收集|2|1|2|2|
|G1收集|2|2|1|2|

|avg(ms)|256M|512M|1G|2G|
|:----|:----|:----|:----|:----|
|串行收集|0.4|0.4|0.4|0.4|
|并行收集|0.3|0.4|0.3|0.5|
|CMS收集|0.3|0.3|0.4|0.5|
|G1收集|0.3|0.4|0.5|0.5|

在压力不变的情况下系统性能并没有随堆空间的增加而提升，反而到2G后还出现下降的趋势。空间增大GC的次数减少，但每次要处理的数据量增多了每次处理的时间也相应增加。

## 堆空间相同，并发压力对CG的影响

在指定256M堆空间的情况下

|RPS|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|3651|3538|3453|2570|
|并行收集|4050|3688|3236|2489|
|CMS收集|3904|3399|2984|2472|
|G1收集|3880|3640|2953|2112|

|95%(ms)|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|2|4|8|17|
|并行收集|2|4|8|19|
|CMS收集|2|5|10|18|
|G1收集|2|5|11|23|

|avg(ms)|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|0.4|0.8|1.2|3.2|
|并行收集|0.3|0.7|1.4|2.9|
|CMS收集|0.3|0.7|1.7|3.4|
|G1收集|0.3|0.7|1.7|4.8|

在指定2G堆空间的情况下

|RPS|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|4473|3537|3177|2272|
|并行收集|4351|3695|3352|2198|
|CMS收集|4441|3655|3329|2530|
|G1收集|4329|3838|3067|2399|

|95%(ms)|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|1|5|9|21|
|并行收集|1|4|8|22|
|CMS收集|1|4|8|18|
|G1收集|1|4|9|19|

|avg(ms)|20并发30秒|30并发30秒|40并发30秒|50并发30秒|
|:----|:----|:----|:----|:----|
|串行收集|0.2|0.7|1.4|4.1|
|并行收集|0.2|0.6|1.3|4.4|
|CMS收集|0.2|0.6|1.2|3.2|
|G1收集|0.2|0.6|1.5|3.4|

![图片](https://uploader.shimo.im/f/kbAMVmmlMoGDzDCe.png!thumbnail)


随着并发量的增加系统应用指标呈指数级衰减，在小空间（256m）时并行收集较优，在大空间（2G）下CMS较优,G1次之。
